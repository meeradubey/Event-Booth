<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Test</title>
  </head>

  <body>
    <main>
      <!-- Displays what the webcam is seeing -->
      <video id="videoCapture" width="640" height="480" autoplay></video>

      <!-- start recording button -->
      <p><button id="btnStart">Record</button></p>

      <!-- stop recording button -->
      <p><button id="btnStop">Stop</button></p>

      <!-- Displays the captured recording -->
      <video id="videoDisplay" controls></video>
    </main>

    <script>
      //binding querySelectors to $ and $$
      const $ = document.querySelector.bind(document);
      const $$ = document.querySelectorAll.bind(document);

      //set recording constraints
      const constraintObj = {
        audio: true,
        video: {
          //setting min and ideal resolution
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 }
        }
      };

      //handle older browsers that might implement getUserMedia in some weird way
      if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
        navigator.mediaDevices.getUserMedia = function(constraintObj) {
          let getUserMedia =
            navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
          if (!getUserMedia) {
            return Promise.reject(
              new Error("getUserMedia is not implemented in this browser")
            );
          }
          return new Promise(function(resolve, reject) {
            getUserMedia.call(navigator, constraintObj, resolve, reject);
          });
        };
      } else {
        navigator.mediaDevices
          .enumerateDevices()
          .then(devices => {
            devices.forEach(device => {
              console.log(device.kind.toUpperCase(), device.label);
            });
          })
          .catch(err => {
            console.log(err.name, err.message);
          });
      }

      //MAIN FUNCTION!!!!
      navigator.mediaDevices
        .getUserMedia(constraintObj)
        .then(function(mediaStreamObj) {
          //connect the media stream to the videoCapture
          const $videoCapture = $("#videoCapture");
          if ("srcObject" in $videoCapture) {
            $videoCapture.srcObject = mediaStreamObj;
          } else {
            //old version
            $videoCapture.src = window.URL.createObjectURL(mediaStreamObj);
          }

          $videoCapture.onloadedmetadata = function(ev) {
            //show in the video element what is being captured by the webcam without sound
            $videoCapture.muted = true;
            $videoCapture.play();
          };

          //add listeners for saving video/audio
          const $start = $("#btnStart");
          const $stop = $("#btnStop");
          const $videoDisplay = $("#videoDisplay");
          const mediaRecorder = new MediaRecorder(mediaStreamObj);
          const chunks = [];

          $start.addEventListener("click", ev => {
            mediaRecorder.start();
            console.log(mediaRecorder.state);
          });
          $stop.addEventListener("click", ev => {
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
          });
          mediaRecorder.ondataavailable = function(ev) {
            chunks.push(ev.data);
          };
          mediaRecorder.onstop = ev => {
            const blob = new Blob(chunks, { type: "video/mp4;" });
            chunks.length = 0;
            const videoURL = window.URL.createObjectURL(blob);
            $videoDisplay.src = videoURL;
          };
        })
        .catch(function(err) {
          console.log(err.name, err.message);
        });

      /*********************************
              getUserMedia returns a Promise
              resolve - returns a MediaStream Object
              reject returns one of the following errors
              AbortError - generic unknown cause
              NotAllowedError (SecurityError) - user rejected permissions
              NotFoundError - missing media track
              NotReadableError - user permissions given but hardware/OS error
              OverconstrainedError - constraint video settings preventing
              TypeError - audio: false, video: false
              *********************************/
    </script>
  </body>
</html>
